# Folyo API Documentation

Backend API completo para gerenciamento de portfolios de criptomoedas.

## üîó Base URL
```
http://folyo.test/api
```

## üîê Autentica√ß√£o

A API usa **sess√µes PHP** para autentica√ß√£o. Ap√≥s login, um cookie `PHPSESSID` √© retornado e deve ser inclu√≠do em todas as requisi√ß√µes subsequentes.

---

## üìã Endpoints

### 1. Autentica√ß√£o (`/api/auth.php`)

#### 1.1. Registro de Usu√°rio
**POST** `/api/auth.php?action=register`

**Body:**
```json
{
  "email": "user@example.com",
  "password": "senha123"
}
```

**Response (201 Created):**
```json
{
  "success": true,
  "data": {
    "message": "Registration successful",
    "user": {
      "id": 1,
      "email": "user@example.com"
    }
  }
}
```

**Erros:**
- `400` - Email inv√°lido ou senha muito curta (< 6 caracteres)
- `409` - Email j√° cadastrado

---

#### 1.2. Login
**POST** `/api/auth.php?action=login`

**Body:**
```json
{
  "email": "user@example.com",
  "password": "senha123"
}
```

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    "message": "Login successful",
    "user": {
      "id": 1,
      "email": "user@example.com"
    }
  }
}
```

**Erros:**
- `401` - Email ou senha inv√°lidos

---

#### 1.3. Logout
**POST** `/api/auth.php?action=logout`

**Headers:**
```
Cookie: PHPSESSID=xxx
```

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    "message": "Logout successful"
  }
}
```

---

#### 1.4. Status de Autentica√ß√£o
**GET** `/api/auth.php?action=status`

**Headers:**
```
Cookie: PHPSESSID=xxx
```

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    "authenticated": true,
    "user": {
      "id": 1,
      "email": "user@example.com"
    }
  }
}
```

---

### 2. Portfolios (`/api/portfolios.php`)

> ‚ö†Ô∏è **Autentica√ß√£o obrigat√≥ria** para todos os endpoints de portfolios

#### 2.1. Listar Portfolios
**GET** `/api/portfolios.php`

**Headers:**
```
Cookie: PHPSESSID=xxx
```

**Response (200 OK):**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "hold wallet",
      "description": "Long term holdings",
      "created_at": "2024-01-01 10:00:00",
      "updated_at": "2024-01-01 10:00:00",
      "unique_cryptos": 3,
      "total_invested": "50534.25"
    }
  ]
}
```

---

#### 2.2. Obter Portfolio Espec√≠fico
**GET** `/api/portfolios.php?id={portfolio_id}`

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "hold wallet",
    "description": "Long term holdings",
    "created_at": "2024-01-01 10:00:00",
    "updated_at": "2024-01-01 10:00:00",
    "holdings": [
      {
        "portfolio_id": 1,
        "crypto_id": 1,
        "crypto_symbol": "BTC",
        "crypto_name": "Bitcoin",
        "total_quantity": "0.800000000000000000",
        "avg_buy_price": "51875.00",
        "cost_basis": "41518.25",
        "transaction_count": 2,
        "first_buy_date": "2024-01-15 10:30:00",
        "last_transaction_date": "2024-02-20 14:15:00"
      }
    ]
  }
}
```

---

#### 2.3. Criar Portfolio
**POST** `/api/portfolios.php`

**Body:**
```json
{
  "name": "My Wallet",
  "description": "Optional description"
}
```

**Response (201 Created):**
```json
{
  "success": true,
  "data": {
    "id": 4,
    "name": "My Wallet",
    "description": "Optional description",
    "created_at": "2024-01-01 12:00:00"
  }
}
```

**Erros:**
- `400` - Nome obrigat√≥rio ou inv√°lido (2-100 caracteres)
- `409` - J√° existe portfolio com este nome

---

#### 2.4. Atualizar Portfolio
**PUT** `/api/portfolios.php?id={portfolio_id}`

**Body:**
```json
{
  "name": "Updated Name",
  "description": "Updated description"
}
```

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "Updated Name",
    "description": "Updated description",
    "created_at": "2024-01-01 10:00:00",
    "updated_at": "2024-01-01 12:30:00"
  }
}
```

---

#### 2.5. Deletar Portfolio
**DELETE** `/api/portfolios.php?id={portfolio_id}`

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    "message": "Portfolio deleted successfully",
    "deleted_portfolio": {
      "id": 1,
      "name": "My Wallet"
    }
  }
}
```

> ‚ö†Ô∏è **Aten√ß√£o:** Deletar um portfolio tamb√©m deleta TODAS as transa√ß√µes relacionadas (CASCADE).

---

### 3. Transa√ß√µes (`/api/transactions.php`)

> ‚ö†Ô∏è **Autentica√ß√£o obrigat√≥ria** para todos os endpoints de transa√ß√µes

#### 3.1. Listar Transa√ß√µes de um Portfolio
**GET** `/api/transactions.php?portfolio_id={portfolio_id}`

**Response (200 OK):**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "portfolio_id": 1,
      "transaction_type": "buy",
      "crypto_id": 1,
      "crypto_symbol": "BTC",
      "crypto_name": "Bitcoin",
      "quantity": "0.500000000000000000",
      "price_per_coin": "50000.00000000",
      "total_amount": "25010.00000000",
      "fee": "10.00000000",
      "currency": "USD",
      "transaction_date": "2024-01-15 10:30:00",
      "notes": "First Bitcoin purchase",
      "created_at": "2024-01-15 11:00:00"
    }
  ]
}
```

---

#### 3.2. Obter Transa√ß√£o Espec√≠fica
**GET** `/api/transactions.php?id={transaction_id}`

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "portfolio_id": 1,
    "transaction_type": "buy",
    "crypto_id": 1,
    "crypto_symbol": "BTC",
    "crypto_name": "Bitcoin",
    "quantity": "0.500000000000000000",
    "price_per_coin": "50000.00000000",
    "total_amount": "25010.00000000",
    "fee": "10.00000000",
    "currency": "USD",
    "transaction_date": "2024-01-15 10:30:00",
    "notes": "First Bitcoin purchase",
    "created_at": "2024-01-15 11:00:00",
    "updated_at": "2024-01-15 11:00:00"
  }
}
```

---

#### 3.3. Criar Transa√ß√£o
**POST** `/api/transactions.php`

**Body:**
```json
{
  "portfolio_id": 1,
  "transaction_type": "buy",
  "crypto_id": 1,
  "crypto_symbol": "BTC",
  "crypto_name": "Bitcoin",
  "quantity": 0.5,
  "price_per_coin": 50000,
  "total_amount": 25010,
  "fee": 10,
  "currency": "USD",
  "transaction_date": "2024-01-15 10:30:00",
  "notes": "Optional notes"
}
```

**Campos:**
- `portfolio_id` (obrigat√≥rio): ID do portfolio
- `transaction_type` (obrigat√≥rio): `"buy"` ou `"sell"`
- `crypto_id` (obrigat√≥rio): ID da API CoinMarketCap
- `crypto_symbol` (obrigat√≥rio): S√≠mbolo da cripto (ex: `"BTC"`)
- `crypto_name` (obrigat√≥rio): Nome da cripto (ex: `"Bitcoin"`)
- `quantity` (obrigat√≥rio): Quantidade de moedas (> 0)
- `price_per_coin` (obrigat√≥rio): Pre√ßo por moeda (> 0)
- `total_amount` (obrigat√≥rio): Total da transa√ß√£o (‚â• 0)
- `fee` (opcional): Taxa da transa√ß√£o (padr√£o: 0)
- `currency` (opcional): Moeda (padr√£o: `"USD"`)
- `transaction_date` (opcional): Data/hora (padr√£o: data atual)
- `notes` (opcional): Observa√ß√µes

**Response (201 Created):**
```json
{
  "success": true,
  "data": {
    "id": 6,
    "portfolio_id": 1,
    "transaction_type": "buy",
    "crypto_id": 1,
    "crypto_symbol": "BTC",
    "crypto_name": "Bitcoin",
    "quantity": "0.500000000000000000",
    "price_per_coin": "50000.00000000",
    "total_amount": "25010.00000000",
    "fee": "10.00000000",
    "currency": "USD",
    "transaction_date": "2024-01-15 10:30:00",
    "notes": "Optional notes",
    "created_at": "2024-01-15 11:00:00",
    "updated_at": "2024-01-15 11:00:00"
  }
}
```

**Erros:**
- `400` - Campos obrigat√≥rios faltando ou valores inv√°lidos
- `404` - Portfolio n√£o encontrado

---

#### 3.4. Atualizar Transa√ß√£o
**PUT** `/api/transactions.php?id={transaction_id}`

**Body:** (todos os campos s√£o opcionais)
```json
{
  "quantity": 0.6,
  "price_per_coin": 51000,
  "total_amount": 30610,
  "notes": "Updated notes"
}
```

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "portfolio_id": 1,
    "transaction_type": "buy",
    "crypto_id": 1,
    "crypto_symbol": "BTC",
    "crypto_name": "Bitcoin",
    "quantity": "0.600000000000000000",
    "price_per_coin": "51000.00000000",
    "total_amount": "30610.00000000",
    "fee": "10.00000000",
    "currency": "USD",
    "transaction_date": "2024-01-15 10:30:00",
    "notes": "Updated notes",
    "created_at": "2024-01-15 11:00:00",
    "updated_at": "2024-01-15 14:30:00"
  }
}
```

---

#### 3.5. Deletar Transa√ß√£o
**DELETE** `/api/transactions.php?id={transaction_id}`

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    "message": "Transaction deleted successfully",
    "deleted_transaction": {
      "id": 1,
      "crypto_symbol": "BTC",
      "transaction_type": "buy",
      "quantity": "0.500000000000000000"
    }
  }
}
```

---

### 4. Holdings (`/api/holdings.php`)

> ‚ö†Ô∏è **Autentica√ß√£o obrigat√≥ria**

Este endpoint combina dados do banco com pre√ßos atuais da API CoinMarketCap para calcular profit/loss em tempo real.

#### 4.1. Holdings de um Portfolio
**GET** `/api/holdings.php?portfolio_id={portfolio_id}`

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    "portfolio": {
      "id": 1,
      "name": "hold wallet"
    },
    "holdings": [
      {
        "portfolio_id": 1,
        "crypto_id": 1,
        "crypto_symbol": "BTC",
        "crypto_name": "Bitcoin",
        "total_quantity": "0.800000000000000000",
        "avg_buy_price": "51875.00",
        "cost_basis": "41518.25",
        "transaction_count": 2,
        "first_buy_date": "2024-01-15 10:30:00",
        "last_transaction_date": "2024-02-20 14:15:00",
        "current_price": 108296.14,
        "current_value": 86636.912,
        "profit_loss": 45118.662,
        "profit_loss_percent": 108.66
      }
    ],
    "summary": {
      "total_value": 86636.912,
      "total_cost": 41518.25,
      "total_profit_loss": 45118.662,
      "total_profit_loss_percent": 108.66,
      "unique_assets": 1
    }
  }
}
```

---

#### 4.2. Overview do Portfolio
**GET** `/api/holdings.php?portfolio_id={portfolio_id}&overview`

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    "portfolio": {
      "id": 1,
      "name": "hold wallet",
      "description": "Long term holdings"
    },
    "total_value": 86636.912,
    "total_cost": 41518.25,
    "profit_loss": 45118.662,
    "profit_loss_percent": 108.66,
    "best_performer": {
      "symbol": "BTC",
      "value": 86636.912,
      "cost": 41518.25,
      "profit_loss": 45118.662,
      "profit_loss_percent": 108.66
    },
    "worst_performer": {
      "symbol": "BTC",
      "value": 86636.912,
      "cost": 41518.25,
      "profit_loss": 45118.662,
      "profit_loss_percent": 108.66
    },
    "allocation": [
      {
        "token": "BTC",
        "percent": 100,
        "value": 86636.912
      }
    ]
  }
}
```

---

#### 4.3. Todos os Holdings do Usu√°rio
**GET** `/api/holdings.php`

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    "holdings": [
      {
        "portfolio_id": 1,
        "portfolio_name": "hold wallet",
        "crypto_id": 1,
        "crypto_symbol": "BTC",
        "crypto_name": "Bitcoin",
        "total_quantity": "0.800000000000000000",
        "avg_buy_price": "51875.00",
        "cost_basis": "41518.25",
        "current_price": 108296.14,
        "current_value": 86636.912,
        "profit_loss": 45118.662,
        "profit_loss_percent": 108.66
      }
    ],
    "summary": {
      "total_value": 86636.912,
      "total_cost": 41518.25,
      "total_profit_loss": 45118.662,
      "total_profit_loss_percent": 108.66,
      "unique_assets": 1
    }
  }
}
```

---

## üìä C√≥digos de Status HTTP

| C√≥digo | Significado |
|--------|-------------|
| `200` | OK - Requisi√ß√£o bem-sucedida |
| `201` | Created - Recurso criado com sucesso |
| `400` | Bad Request - Dados inv√°lidos |
| `401` | Unauthorized - Autentica√ß√£o necess√°ria |
| `404` | Not Found - Recurso n√£o encontrado |
| `405` | Method Not Allowed - M√©todo HTTP inv√°lido |
| `409` | Conflict - Conflito (ex: email j√° existe) |
| `500` | Internal Server Error - Erro no servidor |

---

## üîç Formato de Erros

Todos os erros retornam o seguinte formato:

```json
{
  "success": false,
  "error": "Mensagem de erro descritiva",
  "errors": {
    "campo": "Detalhes do erro"
  }
}
```

---

## üß™ Testes

Execute o teste completo da API:
```
http://folyo.test/api/test_api.php
```

Este teste executa 16 cen√°rios cobrindo todos os endpoints.

---

## üìù Notas Importantes

### Datas de Transa√ß√µes
- ‚úÖ **Sem restri√ß√£o de data** no banco de dados
- ‚úÖ Frontend deve validar a regra de 30 dias:
  - **‚â§ 30 dias**: Buscar pre√ßo automaticamente da API
  - **> 30 dias**: Usu√°rio informa pre√ßo manualmente

### C√°lculos
- **Pre√ßo m√©dio de compra**: Calculado automaticamente pela view `portfolio_holdings`
- **Profit/Loss**: Calculado em tempo real com pre√ßos atuais da API
- **M√©todo**: Average Cost (custo m√©dio ponderado)

### Seguran√ßa
- ‚úÖ Senhas hash com bcrypt
- ‚úÖ Prepared statements (SQL injection)
- ‚úÖ Valida√ß√µes de entrada
- ‚úÖ Sess√µes com timeout de 30 minutos

### Performance
- ‚úÖ Views otimizadas no banco
- ‚úÖ √çndices em campos chave
- ‚úÖ Cache de pre√ßos recomendado (futuro)

---

## üöÄ Pr√≥ximos Passos

1. Integrar frontend com a API
2. Adicionar pagina√ß√£o em listagens
3. Implementar cache de pre√ßos da API
4. Adicionar filtros e ordena√ß√£o
5. Implementar websockets para pre√ßos em tempo real
